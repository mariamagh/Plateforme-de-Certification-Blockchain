<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Registry - Portail</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        /* --- STYLE GLOBAL --- */
        :root { 
            --bg-dark: #0f172a; 
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #e2e8f0; 
            --accent: #8b5cf6; 
            --success: #10b981; 
            --warning: #f59e0b; 
            --danger: #ef4444; 
            --accent-glow: rgba(139, 92, 246, 0.5);
        }
        body { 
            font-family: 'Inter', system-ui, sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text); 
            margin: 0; min-height: 100vh; 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            overflow-x: hidden;
            background: radial-gradient(circle at 10% 20%, rgb(30, 10, 60) 0%, rgb(15, 23, 42) 90%);
        }

        /* ORBES */
        .orb { position: absolute; border-radius: 50%; filter: blur(80px); z-index: -1; opacity: 0.6; animation: float 10s infinite ease-in-out; }
        .orb-1 { width: 400px; height: 400px; background: var(--accent); top: -100px; left: -100px; }
        .orb-2 { width: 300px; height: 300px; background: #3b82f6; bottom: 0; right: -50px; animation-delay: 2s; }
        @keyframes float { 0% { transform: translate(0, 0); } 50% { transform: translate(20px, 30px); } 100% { transform: translate(0, 0); } }

        /* CONTAINERS */
        .centered-container { max-width: 450px; width: 100%; text-align: center; padding: 20px; }
        .main-wrapper { max-width: 1200px; width: 100%; padding: 20px; box-sizing: border-box; display: none; }

        /* --- ‚ú® EFFET BRILLANCE (HOVER SHINE) --- */
        .hover-shine {
            transition: all 0.3s ease;
            border: 1px solid var(--glass-border); 
        }
        .hover-shine:hover {
            border-color: rgba(255, 255, 255, 0.8); 
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3), inset 0 0 20px rgba(255, 255, 255, 0.05); 
            transform: translateY(-2px); 
        }

        /* CARD STYLE */
        .card { 
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 24px; 
            padding: 40px 30px; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3); 
            margin-bottom: 20px; 
        }

        h1 { margin: 0; font-weight: 700; color: white; margin-bottom: 10px; }
        h2 { font-size: 18px; margin-top: 0; margin-bottom: 20px; color: var(--text); }

        /* ACCORD√âON (LISTE D√âROULANTE) */
        .student-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .student-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .student-header h3 { margin: 0; font-size: 16px; color: white; }
        .student-header span { font-size: 12px; color: var(--accent); font-family: monospace; }
        
        .student-details { display: none; padding: 0 20px 20px 20px; border-top: 1px solid var(--glass-border); margin-top: 10px; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .detail-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: #94a3b8; }
        .detail-row b { color: white; }
        
        /* BOUTONS & INPUTS */
        .btn-choice { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; background: transparent; transition: all 0.2s ease; }
        .btn-yes { border: 1px solid var(--success); color: var(--success); background: rgba(16, 185, 129, 0.05); }
        .btn-no { border: 1px solid var(--warning); color: var(--warning); background: rgba(245, 158, 11, 0.05); }
        
        .btn-delete-confirm { border: 1px solid var(--danger); color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .btn-delete-confirm:hover { background: rgba(239, 68, 68, 0.2); box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); }

        .btn-primary { width: 100%; background: var(--accent); color: white; padding: 16px; border-radius: 12px; font-weight: 700; border: none; margin-top: 10px; cursor: pointer; }
        .btn-icon { border:none; padding: 8px 12px; border-radius: 8px; font-size: 16px; margin-right: 5px; cursor: pointer; transition: 0.2s;}
        .btn-icon:hover { transform: scale(1.1); }
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; justify-content: flex-end; }

        input { width: 100%; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; color: white; margin-bottom: 12px; box-sizing: border-box; }
        input:focus { border-color: var(--accent); outline: none; }
        
        /* CORRECTION FOND BLANC : Force le fond sombre m√™me en AutoFill navigateur */
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active{
            /* CORRECTION: Couleur solide #1e293b au lieu de transparent pour masquer le blanc */
            -webkit-box-shadow: 0 0 0 30px #1e293b inset !important;
            -webkit-text-fill-color: white !important;
            transition: background-color 5000s ease-in-out 0s;
        }

        .upload-area { border: 2px dashed var(--glass-border); border-radius: 16px; padding: 30px; text-align: center; cursor: pointer; margin-bottom: 20px; background: rgba(0,0,0,0.2); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 20px; background: var(--glass-bg); backdrop-filter: blur(16px); border-radius: 16px; border: 1px solid var(--glass-border); }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 24px; }
        @media (max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } }
        
        .inline-alert { margin-top: 20px; padding: 15px; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); border-radius: 12px; color: #fca5a5; font-size: 14px; display: none; text-align: center; }
        .inline-alert a { color: white; text-decoration: underline; font-weight: bold; }
        
        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        
        .modal-content { 
            background: #1e293b; 
            padding: 20px; 
            border-radius: 16px; 
            width: 700px; 
            max-width: 90%; 
            height: 80vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            border: 1px solid var(--glass-border);
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        
        .modal-delete-content { 
            background: rgba(30, 41, 59, 0.95); 
            border: 1px solid var(--glass-border);
            padding: 30px; 
            border-radius: 24px; 
            width: 400px; 
            max-width: 90%;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* Modal sp√©cifique pour l'erreur de remplissage (Design comme delete) */
        .modal-alert-content { 
            background: rgba(30, 41, 59, 0.95); 
            border: 1px solid var(--glass-border);
            padding: 30px; 
            border-radius: 24px; 
            width: 400px; 
            max-width: 90%;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        iframe { width: 100%; height: 100%; border: none; flex-grow: 1; border-radius: 8px; background: white; }
    </style>
</head>
<body>

    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>

    <div id="landingSection" class="centered-container">
        <div class="card hover-shine" style="padding-top: 60px; padding-bottom: 60px;">
            <i class="ri-shield-keyhole-line" style="font-size: 60px; color: var(--accent); margin-bottom: 20px; display: block;"></i>
            <h1 style="font-size: 32px;">Student Registry</h1>
            <p style="margin-bottom: 40px;">La certification acad√©mique sur la Blockchain.</p>
            <button onclick="goToChoice()" class="btn-primary hover-shine">
                Entrer dans le portail <i class="ri-arrow-right-line"></i>
            </button>
        </div>
    </div>

    <div id="walletChoiceSection" class="centered-container" style="display: none;">
        <div class="card hover-shine">
            <div style="margin-bottom: 20px;"><i class="ri-shield-keyhole-line" style="font-size: 40px; color: var(--accent);"></i></div>
            <h1>Portail √âtudiant</h1>
            <p style="margin-bottom: 30px;">Acc√®s s√©curis√© au registre d√©centralis√©.</p>
            <p style="color: white; font-weight: 500; margin-bottom: 20px;">Avez-vous un compte MetaMask ?</p>
            
            <button onclick="tryConnectMetaMask()" class="btn-choice btn-yes hover-shine">
                <i class="ri-check-line"></i> Oui, j'ai un compte
            </button>
            
            <button onclick="showInstallMessage()" class="btn-choice btn-no hover-shine">
                <i class="ri-close-line"></i> Non, je n'ai pas de compte
            </button>
            
            <div id="installAlert" class="inline-alert">
                <i class="ri-error-warning-line"></i> MetaMask n'est pas d√©tect√©.<br>
                Veuillez l'installer pour continuer : <br>
                <a href="https://metamask.io/download/" target="_blank">T√©l√©charger MetaMask ü¶ä</a>
            </div>
            
            <div style="margin-top: 20px; font-size: 12px; color: #64748b; cursor: pointer;" onclick="goBackToLanding()">Retour √† l'accueil</div>
        </div>
    </div>

    <div id="dashboardSection" class="main-wrapper">
        <div class="header">
            <div>
                <h1>üéì Portail √âtudiant</h1>
                <div style="font-size: 12px; color: #94a3b8;">
                    <span style="color: var(--success);">‚óè</span> Wallet: <span id="userWallet" style="color: white; font-family: monospace;">...</span>
                </div>
            </div>
            <button onclick="window.location.reload()" style="background: rgba(255,255,255,0.1); color: white; padding: 8px 16px; border-radius: 8px; border:none; cursor:pointer;">D√©connexion</button>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h2>üìù Nouvelle inscription</h2>
                <input type="number" id="newId" placeholder="ID √âtudiant" class="hover-shine" />
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="text" id="firstName" placeholder="Pr√©nom" class="hover-shine" />
                    <input type="text" id="lastName" placeholder="Nom" class="hover-shine" />
                </div>
                <input type="text" id="newCourse" placeholder="Cours (ex: Blockchain)" class="hover-shine" />
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="date" id="newBirth" style="color-scheme: dark;" class="hover-shine" />
                    <input type="number" id="newGrade" placeholder="Note / 20" class="hover-shine" />
                </div>
                <div class="upload-area hover-shine" id="uploadTrigger">
                    <i class="ri-file-upload-line" style="font-size: 24px; color: var(--accent);"></i>
                    <p id="fileName" style="margin: 5px 0 0; font-size: 12px;">Choisir Dipl√¥me (PDF/IMG)</p>
                    <input type="file" id="diplomaFile" style="display: none;" />
                </div>
                <button id="addBtn" class="btn-primary hover-shine">üöÄ Cr√©er & Inscrire (Gasless)</button>
                <p id="addStatus" style="font-size: 12px; color: #94a3b8; text-align: center; margin-top: 10px;"></p>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2>üë• Liste des √©tudiants (<span id="totalCount">0</span>)</h2>
                    <button onclick="loadStudents()" style="background: transparent; border: 1px solid var(--glass-border); color: var(--accent); padding: 5px 10px; border-radius: 6px; cursor: pointer;">
                        <i id="refreshIcon" class="ri-refresh-line"></i>
                    </button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <input type="text" id="searchInput" placeholder="üîç Rechercher par Nom ou ID..." onkeyup="filterStudents()" class="hover-shine" style="border-radius: 12px; background: rgba(0,0,0,0.2);">
                </div>

                <div id="studentListContainer"></div>
            </div>
        </div>
    </div>

    <div id="diplomaModal" class="modal-overlay">
        <div class="modal-content">
            <iframe id="diplomaPreview" src=""></iframe>
            <button onclick="document.getElementById('diplomaModal').style.display='none'" class="btn-choice btn-no hover-shine" style="margin-top: 15px; width: auto; padding: 10px 40px;">
                Fermer l'aper√ßu
            </button>
        </div>
    </div>

    <div id="deleteModal" class="modal-overlay">
        <div class="modal-delete-content hover-shine">
            <i class="ri-error-warning-line" style="font-size: 50px; color: var(--danger); margin-bottom: 20px;"></i>
            <h2 style="color:white; margin-bottom:10px;">Supprimer l'√©tudiant ?</h2>
            <p style="color:#94a3b8; margin-bottom:30px;">Voulez-vous vraiment supprimer cet √©tudiant de la liste locale ? Cette action est irr√©versible.</p>
            <div style="display:flex; gap:15px; justify-content:center;">
                <button onclick="closeDeleteModal()" class="btn-choice btn-no hover-shine" style="margin:0; width:auto; padding:10px 30px;">Annuler</button>
                <button onclick="confirmDeleteAction()" class="btn-choice btn-delete-confirm hover-shine" style="margin:0; width:auto; padding:10px 30px;">Oui, Supprimer</button>
            </div>
        </div>
    </div>

    <div id="alertModal" class="modal-overlay">
        <div class="modal-alert-content hover-shine">
            <i class="ri-information-line" style="font-size: 50px; color: var(--warning); margin-bottom: 20px;"></i>
            <h2 style="color:white; margin-bottom:10px;">Information Manquante</h2>
            <p style="color:#94a3b8; margin-bottom:30px;" id="alertMessage">Veuillez remplir tous les champs obligatoires.</p>
            <button onclick="document.getElementById('alertModal').style.display='none'" class="btn-choice btn-primary hover-shine" style="margin:0 auto; width:auto; padding:10px 40px;">Compris</button>
        </div>
    </div>

    <div id="verifyModal" class="modal-overlay">
        <div class="modal-delete-content hover-shine">
            <i class="ri-compass-3-line" style="font-size: 50px; color: var(--warning); margin-bottom: 20px;"></i>
            
            <h2 style="color:white; margin-bottom:10px;">V√©rifier le contrat ?</h2>
            <p style="color:#94a3b8; margin-bottom:30px;">
                Vous allez √™tre redirig√© vers <b>PolygonScan</b> pour voir toutes les transactions de ce contrat. Voulez-vous continuer ?
            </p>
            
            <div style="display:flex; gap:15px; justify-content:center;">
                <button onclick="closeVerifyModal()" class="btn-choice btn-no hover-shine" style="margin:0; width:auto; padding:10px 30px;">
                    Non, retour
                </button>
                <button onclick="confirmVerifyAction()" class="btn-choice btn-yes hover-shine" style="margin:0; width:auto; padding:10px 30px;">
                    Oui, voir tout
                </button>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = "http://localhost:3000";
        const CONTRACT_ADDRESS = "0x3E2Bf68F9BbD30A83ff3E06C88916592b294ea17"; 
        
        const AMOY_CHAIN_ID_HEX = '0x13882'; 
        const AMOY_CONFIG = { chainId: AMOY_CHAIN_ID_HEX, chainName: 'Polygon Amoy', nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 }, rpcUrls: ['https://rpc-amoy.polygon.technology'], blockExplorerUrls: ['https://amoy.polygonscan.com/'] };

        // NAVIGATION
        function goToChoice() { document.getElementById('landingSection').style.display = 'none'; document.getElementById('walletChoiceSection').style.display = 'block'; }
        function goBackToLanding() { document.getElementById('walletChoiceSection').style.display = 'none'; document.getElementById('landingSection').style.display = 'block'; document.getElementById('installAlert').style.display = 'none'; }
        
        function showInstallMessage() { 
            const msg = document.getElementById('installAlert');
            msg.style.display = 'block';
            msg.innerHTML = `<i class="ri-download-cloud-line"></i> MetaMask n'est pas d√©tect√©.<br>Veuillez l'installer pour continuer : <br><a href="https://metamask.io/download/" target="_blank">T√©l√©charger MetaMask ü¶ä</a>`;
        }

        async function tryConnectMetaMask() {
            const alertBox = document.getElementById('installAlert'); alertBox.style.display = 'none';
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    document.getElementById('walletChoiceSection').style.display = 'none';
                    document.getElementById('dashboardSection').style.display = 'block';
                    document.body.style.justifyContent = 'flex-start';
                    document.getElementById('userWallet').innerText = accounts[0].substring(0, 6) + "...";
                    loadStudents();
                } catch (err) { alertBox.style.display = 'block'; alertBox.innerText = "‚ùå Connexion refus√©e par l'utilisateur."; }
            } else { 
                alertBox.style.display = 'block'; 
                alertBox.innerHTML = `‚ö†Ô∏è MetaMask introuvable !`; 
            }
        }

        // UPLOAD
        const uploadTrigger = document.getElementById('uploadTrigger');
        const diplomaFile = document.getElementById('diplomaFile');
        uploadTrigger.addEventListener('click', () => diplomaFile.click());
        diplomaFile.addEventListener('change', () => { if(diplomaFile.files.length > 0) { document.getElementById('fileName').innerText = "‚úÖ " + diplomaFile.files[0].name; document.getElementById('fileName').style.color = "var(--success)"; } });

        // --- LOGIQUE DU MODAL VERIFICATION ---
        function openVerifyModal() {
            document.getElementById('verifyModal').style.display = 'flex';
        }

        function closeVerifyModal() {
            document.getElementById('verifyModal').style.display = 'none';
        }

        function confirmVerifyAction() {
            // Ouvre l'adresse du contrat sur PolygonScan dans un nouvel onglet
            const url = `https://amoy.polygonscan.com/address/${CONTRACT_ADDRESS}`;
            window.open(url, '_blank');
            closeVerifyModal();
        }

        // GESTION DONN√âES
        let allStudentsGlobal = []; 

        async function loadStudents() {
            const refreshIcon = document.getElementById('refreshIcon');
            try { 
                if(refreshIcon) refreshIcon.classList.add('ri-spin');
                const response = await fetch(`${API_URL}/students`); 
                allStudentsGlobal = await response.json(); 
                renderList(allStudentsGlobal); 
            } catch (error) { 
                console.error("Erreur chargement:", error); 
            } finally {
                if(refreshIcon) setTimeout(() => refreshIcon.classList.remove('ri-spin'), 500);
            }
        }

        function filterStudents() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allStudentsGlobal.filter(s => s.name.toLowerCase().includes(query) || s.id.toString().includes(query));
            renderList(filtered);
        }

        function renderList(data) {
            const container = document.getElementById('studentListContainer');
            container.innerHTML = "";
            document.getElementById('totalCount').innerText = data.length;

            data.forEach(s => {
                let btns = "";
                if(s.ipfsLink) {
                    btns += `<button class="btn-icon" style="background:var(--accent); color:white;" onclick="viewDiploma('${s.ipfsLink}')"><i class="ri-eye-line"></i></button>`;
                    btns += `<button class="btn-icon" style="background:#f59e0b; color:black;" onclick="openVerifyModal()" title="V√©rifier sur la Blockchain"><i class="ri-file-list-3-line"></i></button>`;
                }
                btns += `<button class="btn-icon" style="background:rgba(239,68,68,0.2); color:var(--danger);" onclick="askDelete('${s.id}')"><i class="ri-delete-bin-line"></i></button>`;

                let gradeColor = s.grade >= 10 ? "var(--success)" : "var(--danger)";
                
                let item = `
                <div class="student-item hover-shine">
                    <div class="student-header" onclick="toggleDetails(this)">
                        <div>
                            <h3 style="display:flex; align-items:center; gap:10px;">
                                <i class="ri-arrow-down-s-line" style="transition:0.3s"></i> 
                                ${s.name}
                            </h3>
                            <span style="opacity:0.6; font-size:12px; margin-left:25px;">${s.course}</span>
                        </div>
                        <span>ID #${s.id}</span>
                    </div>
                    
                    <div class="student-details">
                        <div style="padding-top:10px;">
                            <div class="detail-row"><span>Note Obtenue:</span> <b style="color:${gradeColor}">${s.grade}/20</b></div>
                            <div class="detail-row"><span>Date de Naissance:</span> <b>${s.birthDate || "Non renseign√©"}</b></div>
                            <div class="detail-row"><span>Statut Dipl√¥me:</span> <b>${s.ipfsLink ? "‚úÖ Certifi√©" : "‚ùå Non Certifi√©"}</b></div>
                            <div class="action-buttons">${btns}</div>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += item;
            });
        }

        window.toggleDetails = function(header) {
            const details = header.nextElementSibling;
            const icon = header.querySelector('i');
            if (details.style.display === "block") { details.style.display = "none"; icon.style.transform = "rotate(0deg)"; } 
            else { details.style.display = "block"; icon.style.transform = "rotate(180deg)"; }
        }

        function viewDiploma(url) { document.getElementById('diplomaPreview').src = url; document.getElementById('diplomaModal').style.display = 'flex'; }

        // SUPPRESSION
        let idToDelete = null;
        function askDelete(id) { idToDelete = id; document.getElementById('deleteModal').style.display = 'flex'; }
        function closeDeleteModal() { document.getElementById('deleteModal').style.display = 'none'; idToDelete = null; }

        async function confirmDeleteAction() {
            if(!idToDelete) return;
            try { 
                await fetch(`${API_URL}/delete-student`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: idToDelete }) }); 
                loadStudents(); 
                closeDeleteModal();
            } catch(e) { alert("Erreur suppression"); closeDeleteModal(); }
        }

        // FONCTION ALERTE CUSTOM
        function showCustomAlert(title, message) {
            const modal = document.getElementById('alertModal');
            modal.querySelector('h2').innerText = title;
            document.getElementById('alertMessage').innerHTML = message;
            modal.style.display = 'flex';
        }

        // AJOUT (Version corrig√©e avec Timer et Fallback)
        document.getElementById('addBtn').addEventListener('click', async () => {
            const id = document.getElementById('newId').value;
            const lastName = document.getElementById('lastName').value;
            const firstName = document.getElementById('firstName').value;
            const name = `${firstName} ${lastName}`; 
            const course = document.getElementById('newCourse').value;
            const birthDate = document.getElementById('newBirth').value;
            const grade = document.getElementById('newGrade').value;
            const fileInput = document.getElementById('diplomaFile');
            const file = fileInput.files[0];
            const status = document.getElementById('addStatus');

            // Validation
            if(!id || !lastName || !firstName || !course || !grade || !birthDate || !file) {
                showCustomAlert("Oups !", "Veuillez remplir toutes les informations (ID, Pr√©nom, Nom, Cours, Date, Note, Dipl√¥me).");
                return;
            }

            status.innerHTML = "<i class='ri-loader-4-line ri-spin'></i> Envoi au Relayer...";
            
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                const formData = new FormData();
                formData.append('id', id); formData.append('name', name); 
                formData.append('course', course); formData.append('birthDate', birthDate);
                formData.append('grade', grade); formData.append('studentWallet', accounts[0]);
                formData.append('diploma', file);

                const res = await fetch(`${API_URL}/add-student`, { method: 'POST', body: formData });
                const result = await res.json();
                
                if(result.success) {
                    loadStudents();

                    // 1. Nettoyage
                    document.getElementById('newId').value = "";
                    document.getElementById('lastName').value = "";
                    document.getElementById('firstName').value = "";
                    document.getElementById('newCourse').value = "";
                    document.getElementById('newBirth').value = "";
                    document.getElementById('newGrade').value = "";
                    fileInput.value = ""; 
                    document.getElementById('fileName').innerText = "Choisir Dipl√¥me (PDF/IMG)";
                    document.getElementById('fileName').style.color = "#94a3b8"; 

                    // 2. Affichage du Timer
                    // On injecte le HTML
                    // --- 2. BOUTON ORANGE (Version Modal) ---
                    status.innerHTML = `
                        <div style="margin-top: 15px;">
                            <div style="color: var(--success); margin-bottom: 10px; font-weight: bold;">
                                ‚úÖ NFT cr√©√© (ID: ${result.tokenId}) !
                            </div>
                            <button onclick="openVerifyModal()" class="btn-primary hover-shine" style="background: #f59e0b; color: black;">
                                <i class="ri-file-list-3-line"></i> V√©rifier les transactions
                            </button>
                        </div>
                    `;

                    // 3. Logique du Timer (Ex√©cut√©e imm√©diatement apr√®s l'injection HTML)
                    let timeLeft = 10;
                    const btnTimer = document.getElementById('btnTimerMetaMask');
                    
                    const timerInterval = setInterval(() => {
                        timeLeft--;
                        if(btnTimer) { // V√©rification de s√©curit√©
                            if(timeLeft > 0) {
                                btnTimer.innerHTML = `<i class="ri-loader-4-line ri-spin"></i> Attente r√©seau (${timeLeft}s)...`;
                            } else {
                                clearInterval(timerInterval);
                                btnTimer.disabled = false;
                                btnTimer.style.background = "#f59e0b"; // Orange
                                btnTimer.style.cursor = "pointer";
                                btnTimer.style.opacity = "1";
                                btnTimer.innerHTML = `<i class="ri-fox-line"></i> Ajouter au Wallet`;
                                btnTimer.onclick = function() { safeAddToMetaMask(result.tokenId); };
                            }
                        } else {
                            clearInterval(timerInterval); // Si le bouton n'existe plus (changement de page), on arr√™te
                        }
                    }, 1000);

                } else { status.innerText = "‚ùå Erreur: " + JSON.stringify(result); }
            } catch(e) { status.innerText = "‚ùå Erreur Serveur"; console.error(e); }
        });

        // Correction : Symbole SDIP + Gestion d'erreur "Unable to verify"
        async function safeAddToMetaMask(tokenId) {
            const status = document.getElementById('addStatus');
            const btnTimer = document.getElementById('btnTimerMetaMask'); // On r√©cup√®re le bouton
            
            // Changement d'√©tat visuel
            if(btnTimer) {
                btnTimer.innerHTML = "<i class='ri-loader-4-line ri-spin'></i> Ouverture MetaMask...";
                btnTimer.disabled = true;
            } else {
                status.innerHTML = "ü¶ä Ouverture de MetaMask...";
            }

            try {
                // 1. V√©rification du R√©seau
                await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: AMOY_CHAIN_ID_HEX }] });
            } catch (e) {
                // Si le r√©seau n'existe pas, on l'ajoute
                if (e.code === 4902) await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [AMOY_CONFIG] });
            }

            try {
                // 2. Demande d'ajout (CORRIG√â : Symbole SDIP)
                await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: { 
                        type: 'ERC721', 
                        options: { 
                            address: CONTRACT_ADDRESS, 
                            tokenId: tokenId.toString(), 
                            symbol: "SDIP", 
                            decimals: 0 
                        } 
                    },
                });
                
                // Succ√®s
                if(btnTimer) {
                    btnTimer.innerHTML = "‚úÖ Ajout√© dans MetaMask !";
                    btnTimer.style.background = "var(--success)";
                    btnTimer.style.color = "white";
                } else {
                    status.innerHTML = "‚úÖ Ajout√© !";
                }

            } catch (error) {
                console.error(error);
                // Si MetaMask √©choue (Erreur de propri√©t√© ou Annulation), on affiche le LIEN PolygonScan
                const errorMsg = "‚ö†Ô∏è Impossible de v√©rifier le token (R√©seau lent).";
                const link = `https://amoy.polygonscan.com/token/${CONTRACT_ADDRESS}?a=${tokenId}`;
                
                status.innerHTML = `
                    <div style="margin-top:10px; color:#fca5a5;">${errorMsg}</div>
                    <a href="${link}" target="_blank" class="btn-primary hover-shine" style="display:block; text-align:center; text-decoration:none; margin-top:5px; background:var(--accent);">
                        <i class="ri-external-link-line"></i> Voir la preuve sur PolygonScan
                    </a>
                `;
            }
        }
    </script>
</body>
</html>